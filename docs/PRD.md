# Odoo 模块依赖分析器 - 产品需求文档 (PRD)

**版本**: 1.0.0  
**更新日期**: 2026-01-07  
**作者**: Galaxy  
**状态**: 已实现

---

## 1. 产品概述

### 1.1 产品定位

Odoo 模块依赖分析器是一款专为 Odoo ERP 系统设计的模块依赖关系分析和升级辅助工具，帮助开发者和系统管理员理解模块间的依赖关系，评估升级风险，并提供自动化的升级辅助功能。

### 1.2 目标用户

- Odoo 模块开发者
- Odoo 系统管理员
- Odoo 实施顾问
- 技术团队负责人

### 1.3 核心价值

| 价值点 | 描述 |
|--------|------|
| 可视化理解 | 直观展示复杂的模块依赖关系 |
| 风险评估 | 量化升级影响，降低升级风险 |
| 效率提升 | 自动化检测和修复，减少人工工作 |
| 知识沉淀 | 保存分析历史，便于团队协作 |

---

## 2. 功能需求

### 2.1 模块扫描与分析

#### 2.1.1 模块扫描

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 路径扫描 | 扫描本地目录下的所有 Odoo 模块 | 完成 |
| ZIP 上传 | 上传 ZIP 压缩包进行分析 | 完成 |
| Manifest 解析 | 解析 __manifest__.py 和 __openerp__.py | 完成 |
| 多路径支持 | 同时扫描多个模块目录 | 完成 |
| 历史路径 | 记录并快速选择历史扫描路径 | 完成 |

#### 2.1.2 依赖分析

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 依赖图构建 | 使用 NetworkX 构建有向依赖图 | 完成 |
| 循环依赖检测 | 检测模块间的循环依赖 | 完成 |
| 缺失依赖检测 | 识别未安装的依赖模块 | 完成 |
| 反向依赖查询 | 查询哪些模块依赖指定模块 | 完成 |
| 安装顺序计算 | 计算正确的模块安装顺序 | 完成 |

#### 2.1.3 统计信息

| 统计项 | 描述 |
|--------|------|
| 模块总数 | 扫描到的模块数量 |
| 依赖关系数 | 模块间依赖关系总数 |
| 应用模块数 | 标记为 application 的模块数 |
| 分类数量 | 模块分类的数量 |
| 最多被依赖 | 被最多模块依赖的模块排名 |

---

### 2.2 可视化展示

#### 2.2.1 依赖关系图

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 交互式图表 | 使用 vis.js 渲染交互式依赖图 | 完成 |
| 节点着色 | 按模块类型着色 | 完成 |
| 缩放平移 | 支持图表缩放和拖拽 | 完成 |
| 节点点击 | 点击节点查看模块详情 | 完成 |
| 物理引擎 | 自动布局算法 | 完成 |

#### 2.2.2 模块列表

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 列表展示 | 展示所有模块的基本信息 | 完成 |
| 搜索过滤 | 按名称搜索模块 | 完成 |
| 分类筛选 | 按分类筛选模块 | 完成 |
| 详情查看 | 查看模块的完整信息 | 完成 |

#### 2.2.3 依赖树

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 树形展示 | 展示模块的依赖树结构 | 完成 |
| 层级展开 | 支持展开/折叠子依赖 | 完成 |

---

### 2.3 升级分析

#### 2.3.1 数据模型分析

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 模型识别 | 识别 _name, _inherit, _inherits 定义 | 完成 |
| 字段解析 | 解析所有字段类型和属性 | 完成 |
| 关系分析 | 分析 Many2one, One2many, Many2many 关系 | 完成 |
| 方法统计 | 统计模型方法数量 | 完成 |
| 模块过滤 | 按模块筛选模型 | 完成 |

#### 2.3.2 升级影响评估

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 直接依赖 | 计算直接依赖该模块的模块数 | 完成 |
| 全部依赖 | 计算所有间接依赖的模块数 | 完成 |
| 影响模型 | 识别受影响的数据模型 | 完成 |
| 风险评级 | 低/中/高/极高四级风险评估 | 完成 |
| 影响分数 | 量化的影响分数 | 完成 |
| 风险因素 | 列出具体的风险因素 | 完成 |
| 升级建议 | 提供针对性的升级建议 | 完成 |

#### 2.3.3 版本对比

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 模块对比 | 对比两个版本的模块差异 | 完成 |
| 新增模块 | 识别目标版本新增的模块 | 完成 |
| 删除模块 | 识别目标版本删除的模块 | 完成 |
| 修改模块 | 识别有变更的模块 | 完成 |
| 依赖变更 | 分析依赖关系的变化 | 完成 |

---

### 2.4 升级工具

#### 2.4.1 代码问题检测

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 废弃 API 检测 | 检测各版本废弃的 API 调用 | 完成 |
| 代码模式检测 | 检测旧代码模式 | 完成 |
| 自动修复标记 | 标记可自动修复的问题 | 完成 |
| 修复建议 | 提供具体的修复建议 | 完成 |

支持检测的废弃 API:

- Odoo 14 到 15: topological_sort, report_sxw
- Odoo 15 到 16: pycompat, @api.multi, @api.one
- Odoo 16 到 17: fields.Serialized, web.assets_backend
- Odoo 17 到 18: oldname 参数

支持检测的代码模式:

- @api.multi / @api.one 装饰器
- self.pool.get() 旧式 ORM
- from openerp import 旧式导入
- browse(cr, uid, ...) 旧式 API

#### 2.4.2 迁移脚本生成

| 功能项 | 描述 | 状态 |
|--------|------|------|
| pre-migrate.py | 升级前执行的脚本模板 | 完成 |
| post-migrate.py | 升级后执行的脚本模板 | 完成 |
| end-migrate.py | 所有模块升级完成后执行 | 完成 |
| 版本号自动更新 | 自动计算新版本号 | 完成 |
| 保存到模块目录 | 自动保存到 migrations 目录 | 完成 |

#### 2.4.3 升级检查清单

| 分类 | 检查项 |
|------|--------|
| 备份 | 数据库完整备份、代码仓库备份、配置文件备份 |
| 环境 | 测试环境准备、Python 版本检查、依赖包更新 |
| 代码 | 代码问题修复、Manifest 版本更新、迁移脚本准备 |
| 数据 | 自定义字段检查、视图验证、报表检查 |
| 测试 | 单元测试执行、功能回归测试、性能测试 |
| 部署 | 停机通知、回滚计划、升级后验证 |

#### 2.4.4 自动修复

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 预览模式 | 预览将要修改的代码 | 完成 |
| 应用模式 | 实际应用修复 | 完成 |
| 修复报告 | 显示修复结果统计 | 完成 |

---

### 2.5 存储与历史

#### 2.5.1 分析历史

| 功能项 | 描述 | 状态 |
|--------|------|------|
| 保存分析 | 保存当前分析结果到历史 | 完成 |
| 历史列表 | 查看所有历史分析记录 | 完成 |
| 加载历史 | 从历史记录加载分析结果 | 完成 |
| 删除记录 | 删除不需要的历史记录 | 完成 |
| 重新分析 | 从保存的 ZIP 重新分析 | 完成 |

#### 2.5.2 存储后端

| 后端 | 场景 | 状态 |
|------|------|------|
| 本地存储 | 本地部署时使用 | 完成 |
| Vercel Blob | 云端部署时使用 | 完成 |

---

### 2.6 数据导出

| 导出格式 | 描述 | 状态 |
|----------|------|------|
| JSON | 导出完整的分析数据 | 完成 |
| HTML | 导出交互式依赖图 | 完成 |

---

## 3. 非功能需求

### 3.1 性能要求

| 指标 | 要求 |
|------|------|
| 扫描速度 | 500+ 模块小于 5 秒 |
| 页面加载 | 首屏小于 2 秒 |
| 文件上传 | 支持 100MB 以内的 ZIP |

### 3.2 兼容性要求

| 平台 | 要求 |
|------|------|
| Odoo 版本 | 8.0 - 18.0 |
| Python 版本 | 3.8+ |
| 浏览器 | Chrome, Firefox, Safari, Edge 最新版 |

### 3.3 部署要求

| 部署方式 | 描述 |
|----------|------|
| 本地部署 | python run.py 一键启动 |
| 云端部署 | 支持 Vercel Serverless 部署 |
| Docker | 支持 Docker 容器化部署 |

---

## 4. 技术架构

### 4.1 技术栈

| 层级 | 技术 |
|------|------|
| 后端 | Python 3.8+, Flask |
| 前端 | HTML5, CSS3, JavaScript |
| 图表 | vis.js, PyVis |
| 图算法 | NetworkX |
| 解析 | Python AST |
| 存储 | 本地文件系统 / Vercel Blob |
| 部署 | Vercel Serverless |

### 4.2 项目结构

```
odoo-depends/
  odoo_depends/           # 核心模块
    __init__.py
    analyzer.py           # 模块扫描和依赖分析
    visualizer.py         # 可视化生成
    upgrade_analyzer.py   # 升级分析
    migration_helper.py   # 迁移辅助
    cloud_storage.py      # 云存储
    web_app.py            # Flask Web 应用
    cli.py                # 命令行接口
  api/
    index.py              # Vercel 入口
  docs/
    PRD.md                # 需求文档
    Chatlog.md            # 开发日志
  odoo-test/              # 测试模块
    addons/
  run.py                  # 启动脚本
  requirements.txt        # 依赖列表
  vercel.json             # Vercel 配置
  README.md               # 项目说明
```

### 4.3 API 接口

#### 扫描相关

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/scan | 扫描本地路径 |
| POST | /api/upload | 上传 ZIP 分析 |

#### 分析相关

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/graph-data | 获取依赖图数据 |
| GET | /api/tree/MODULE | 获取依赖树 |
| GET | /api/order | 获取安装顺序 |
| GET | /api/models | 获取模型分析 |
| GET | /api/impact/MODULE | 获取升级影响 |
| POST | /api/compare | 版本对比 |

#### 迁移相关

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/migration/analyze | 分析代码问题 |
| GET | /api/migration/scripts/MODULE | 获取迁移脚本 |
| POST | /api/migration/scripts/MODULE/save | 保存迁移脚本 |
| POST | /api/migration/auto-fix | 自动修复 |

#### 存储相关

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/storage/upload | 上传并保存 |
| GET | /api/storage/records | 获取历史记录 |
| POST | /api/storage/save-current | 保存当前分析 |
| DELETE | /api/storage/record/ID | 删除记录 |

---

## 5. 用户界面

### 5.1 页面结构

主要页面:

- 扫描模块: 配置扫描路径和上传文件
- 依赖图: 交互式依赖关系图
- 模块列表: 所有模块的列表视图
- 依赖树: 树形依赖结构
- 安装顺序: 正确的安装顺序
- 问题检查: 循环依赖和缺失依赖
- 模型分析: 数据模型分析
- 影响评估: 升级影响评估
- 版本对比: 两个版本对比
- 升级工具: 代码检测和迁移脚本
- 分析历史: 历史记录管理
- 导出: JSON 和 HTML 导出

### 5.2 主题设计

- 风格: 深色科技风
- 主色调: 深蓝
- 强调色: 青色, 红色, 绿色
- 字体: JetBrains Mono (代码), Noto Sans SC (中文)

---

## 6. 部署信息

### 6.1 在线访问

| 平台 | 地址 |
|------|------|
| Web 应用 | https://odoo-depends.vercel.app |
| 源代码 | https://github.com/Albertsun6/odoo-depends |

### 6.2 本地安装

```bash
# 克隆代码
git clone https://github.com/Albertsun6/odoo-depends.git
cd odoo-depends

# 安装依赖
pip install -r requirements.txt

# 启动服务
python run.py -p 8080

# 访问 http://localhost:8080
```

---

## 7. 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2026-01-07 | 初始版本 |

---

## 8. 后续规划

### 8.1 短期计划 (v1.1)

- 支持多语言 (英文)
- 模块对比详情 (字段级别差异)
- 导出 PDF 报告

### 8.2 中期计划 (v1.2)

- 团队协作功能
- 定时扫描任务
- Webhook 通知

### 8.3 长期计划 (v2.0)

- AI 辅助代码修复
- 自动化升级流水线
- 与 CI/CD 集成

---

文档结束
